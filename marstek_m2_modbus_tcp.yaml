# -----------------------------------------------------------------
# Home Assistant Marstek V3 - Modbus TCP/IP direct through ethernet
# Version: 1.1
# Note: Only for EMS V144 or higher
# Fork of https://github.com/Superduper1969/MarstekVenus-ElfinEW11
# -----------------------------------------------------------------
# Use this file for the second Marstek Venus.
# change host: [YOURIPADRESS] to host: 192.168.0.245 (for example)
# -----------------------------------------------------------------

# ------
# MODBUS
# ------
modbus:
  - name: marstekvenus2  # Rename marstekvenus1 to marstekvenus2, or marstekvenus3 when multiple batteries
    type: tcp
    host: [YOURIPADRESS]
    port: 502
    delay: 1
    message_wait_milliseconds: 35
    timeout: 20

    sensors:
      - name: "Marstek m2 Wifi state number"
        unique_id: marstek_m2_wifi_state_number
        address: 30300
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        state_class: measurement
        # 0 = Disconnected
        # 1 = Connected

      - name: "Marstek m2 BT state number"
        unique_id: marstek_m2_bt_state_number
        address: 30301
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        state_class: measurement
        # 0 = Disconnected
        # 1 = Connected after reboot
        # 2 = Connected
        # 3 = Active

      - name: "Marstek m2 Cloud state number"
        unique_id: marstek_m2_cloud_state_number
        address: 30302
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        state_class: measurement
        # 0 = Disconnected
        # 1 = Connected

      - name: "Marstek m2 Battery Wifi Signal Strength"
        unique_id: marstek_m2_battery_wifi_signal_strength
        address: 30303
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int16
        unit_of_measurement: dBm
        device_class: signal_strength
        state_class: measurement
        scale: -1
        offset: 0
        precision: 0

      - name: "Marstek m2 MAC"
        unique_id: marstek_m2_mac
        address: 30304
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: custom
        count: 6
        structure: ">12s"

      - name: "Marstek m2 COM Module version"
        unique_id: marstek_m2_com_module_version
        address: 30350
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: custom
        count: 6
        structure: ">12s"

      - name: "Marstek m2 Device Name"
        unique_id: marstek_m2_device_name
        address: 31000
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: custom
        count: 10
        structure: ">20s"

      - name: "Marstek m2 EMS version"
        unique_id: marstek_m2_ems_version
        address: 30200
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek m2 VNS version"
        unique_id: marstek_m2_vns_version
        address: 30202
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek m2 BMS version"
        unique_id: marstek_m2_bms_version
        address: 30204
        slave: 1
        scan_interval: 300
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek m2 Battery Voltage"
        unique_id: marstek_m2_battery_voltage
        address: 30100
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: uint16
        unit_of_measurement: V
        device_class: voltage
        state_class: measurement
        scale: 0.01
        offset: 0
        precision: 1

      - name: "Marstek m2 Battery Current"
        unique_id: marstek_m2_battery_current
        address: 30101
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: int16
        unit_of_measurement: A
        device_class: current
        state_class: measurement
        scale: 0.01
        offset: 0
        precision: 1

      - name: "Marstek m2 Battery Power"
        unique_id: marstek_m2_battery_power
        address: 30001
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: int16
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek m2 Battery State Of Charge"
        unique_id: marstek_m2_battery_state_of_charge
        address: 32104
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek m2 Battery Total Energy"
        unique_id: marstek_m2_battery_total_energy
        address: 32105
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: kWh
        device_class: energy_storage
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 2

      - name: "Marstek m2 AC Voltage"
        unique_id: marstek_m2_ac_voltage
        address: 32200
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: V
        device_class: voltage
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek m2 AC Power"
        unique_id: marstek_m2_ac_power
        address: 32202
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: int32
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek m2 AC Frequency"
        unique_id: marstek_m2_ac_frequency
        address: 32204
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: Hz
        device_class: frequency
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 2

#      - name: "Marstek m2 AC Offgrid Voltage"  # 32300 gives 0x7E2C modbus error on v3
#        unique_id: marstek_m2_ac_offgrid_voltage
#        address: 32300
#        slave: 1
#        scan_interval: 30
#        input_type: holding
#        data_type: uint16
#        unit_of_measurement: V
#        device_class: voltage
#        state_class: measurement
#        scale: 0.1
#        offset: 0
#        precision: 1

#      - name: "Marstek m2 AC Offgrid Current"
#        unique_id: marstek_m2_ac_offgrid_current
#        address: 32301
#        slave: 1
#        scan_interval: 30
#        input_type: holding
#        data_type: int16
#        unit_of_measurement: A
#       device_class: current
#        state_class: measurement
#        scale: 0.01
#        offset: 0
#        precision: 1

#      - name: "Marstek m2 AC Offgrid Power"
#        unique_id: marstek_m2_ac_offgrid_power
#        address: 32302
#        slave: 1
#        scan_interval: 30
#        input_type: holding
#       data_type: int32
#       unit_of_measurement: W
#        device_class: power
#        state_class: measurement
#        scale: 1
#        offset: 0
#        precision: 0

      - name: "Marstek m2 Lifetime Charging Energy"
        unique_id: marstek_m2_lifetime_charging_energy
        address: 33000
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek m2 Lifetime Discharging Energy"
        unique_id: marstek_m2_lifetime_discharging_energy
        address: 33002
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek m2 Daily Charging Energy"
        unique_id: marstek_m2_daily_charging_energy
        address: 33004
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek m2 Daily Discharging Energy"
        unique_id: marstek_m2_daily_discharging_energy
        address: 33006
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek m2 monthly Charging Energy"
        unique_id: marstek_m2_monthly_charging_energy
        address: 33008
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek m2 Monthly Discharging Energy"
        unique_id: marstek_m2_monthly_discharging_energy
        address: 33010
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint32
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        scale: 0.01
        offset: 0
        precision: 2

      - name: "Marstek m2 Battery Cell 1 Voltage"
        unique_id: marstek_m2_battery_cell_1_voltage
        address: 34018
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 2 Voltage"
        unique_id: marstek_m2_battery_cell_2_voltage
        address: 34019
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 3 Voltage"
        unique_id: marstek_m2_battery_cell_3_voltage
        address: 34020
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 4 Voltage"
        unique_id: marstek_m2_battery_cell_4_voltage
        address: 34021
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 5 Voltage"
        unique_id: marstek_m2_battery_cell_5_voltage
        address: 34022
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 6 Voltage"
        unique_id: marstek_m2_battery_cell_6_voltage
        address: 34023
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 7 Voltage"
        unique_id: marstek_m2_battery_cell_7_voltage
        address: 34024
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 8 Voltage"
        unique_id: marstek_m2_battery_cell_8_voltage
        address: 34025
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 9 Voltage"
        unique_id: marstek_m2_battery_cell_9_voltage
        address: 34026
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 10 Voltage"
        unique_id: marstek_m2_battery_cell_10_voltage
        address: 34027
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 11 Voltage"
        unique_id: marstek_m2_battery_cell_11_voltage
        address: 34028
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 12 Voltage"
        unique_id: marstek_m2_battery_cell_12_voltage
        address: 34029
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3


      - name: "Marstek m2 Battery Cell 13 Voltage"
        unique_id: marstek_m2_battery_cell_13_voltage
        address: 34030
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 14 Voltage"
        unique_id: marstek_m2_battery_cell_14_voltage
        address: 34031
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 15 Voltage"
        unique_id: marstek_m2_battery_cell_15_voltage
        address: 34032
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Cell 16 Voltage"
        unique_id: marstek_m2_battery_cell_16_voltage
        address: 34033
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Internal Temperature"
        unique_id: marstek_m2_internal_temperature
        address: 35000
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek m2 Internal MOS1 Temperature"
        unique_id: marstek_m2_internal_mos1_temperature
        address: 35001
        slave: 1
        scan_interval: 600
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek m2 Internal MOS2 Temperature"
        unique_id: marstek_m2_internal_mos2_temperature
        address: 35002
        slave: 1
        scan_interval: 600
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek m2 Max Cell Temperature"
        unique_id: marstek_m2_max_cell_temperature
        address: 35010
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek m2 Min Cell Temperature"
        unique_id: marstek_m2_min_cell_temperature
        address: 35011
        slave: 1
        scan_interval: 30
        input_type: holding
        data_type: int16
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek m2 Inverter State Number"
        unique_id: marstek_m2_inverter_state_number
        address: 35100
        slave: 1
        scan_interval: 5
        input_type: holding
        data_type: uint16
        state_class: measurement
        # 0 Sleep
        # 1 Stand-By
        # 2 Charge
        # 3 Discharge
        # 4 Backup/Mode or Fault
        # 5 OTA Upgrade
        # 6 Bypass

      - name: "Marstek m2 Battery Charge Voltage Limit"
        unique_id: marstek_m2_battery_charge_voltage_limit
        address: 35110
        slave: 1
        scan_interval: 90
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek m2 Battery Charge Current Limit"
        unique_id: marstek_m2_battery_charge_current_limit
        address: 35111
        slave: 1
        scan_interval: 90
        input_type: holding
        data_type: uint16
        unit_of_measurement: "A"
        state_class: measurement
        scale: 0.1
        offset: 0
        precision: 1

      - name: "Marstek m2 Battery Discharge Current Limit"
        unique_id: marstek_m2_battery_discharge_current_limit
        address: 35112
        slave: 1
        scan_interval: 90
        input_type: holding
        data_type: uint16
        unit_of_measurement: "A"
        state_class: measurement
        scale: 0.01
        offset: 0
        precision: 1

      - name: "Marstek m2 Battery Maximum Cell Voltage"
        unique_id: marstek_m2_battery_maximum_cell_voltage
        address: 37007
        slave: 1
        scan_interval: 90
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Battery Minimum Cell Voltage"
        unique_id: marstek_m2_battery_minimum_cell_voltage
        address: 37008
        slave: 1
        scan_interval: 90
        input_type: holding
        data_type: uint16
        unit_of_measurement: "V"
        state_class: measurement
        scale: 0.001
        offset: 0
        precision: 3

      - name: "Marstek m2 Backup Function Number"
        unique_id: marstek_m2_backup_function_number
        address: 41200
        slave: 1
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0
        # 0 enable
        # 1 disable

      - name: "Marstek m2 RS485 Control Mode Number"
        unique_id: marstek_m2_rs485_control_mode_number
        address: 42000
        slave: 1
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0
        # Registers 42000 - 42999 only work when this is set.
        # 0x55AA = Enable 21930
        # 0x55BB = Disable 21947

      - name: "Marstek m2 Forcible Charge Discharge Number"
        unique_id: marstek_m2_forcible_charge_discharge_number
        address: 42010
        slave: 1
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0
        # 0 stop
        # 1 Forces to charge according to 42020 value
        # 2 Forces to discharge according to 42021 value
        # Works as follow:
        # - 42000 write 55AA
        # - 42020 write value or 42021 write value
        # - 42010 set to 1 or 2
        # - 42000 write 55BB = disable

      - name: "Marstek m2 Charge To SOC Number"
        unique_id: marstek_m2_charge_to_soc_number
        address: 42011
        slave: 1
        input_type: holding
        data_type: uint16
        unit_of_measurement: "%"
        scale: 1
        offset: 0
        precision: 0
        # Overrides 42010
        # Works as follow:
        # - 42000 write 55AA
        # - 42011 write value
        # - 42000 write 55BB = disable

      - name: "Marstek m2 Forcible Charge Power Number"
        unique_id: marstek_m2_forcible_charge_power_number
        address: 42020
        slave: 1
        input_type: holding
        data_type: uint16
        unit_of_measurement: W
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek m2 Forcible Discharge Power Number"
        unique_id: marstek_m2_forcible_discharge_power_number
        address: 42021
        slave: 1
        input_type: holding
        data_type: uint16
        unit_of_measurement: W
        scale: 1
        offset: 0
        precision: 0

      - name: "Marstek m2 User Work Mode number"
        unique_id: marstek_m2_user_work_mode_number
        address: 43000
        slave: 1
        scan_interval: 10
        input_type: holding
        data_type: uint16
        scale: 1
        offset: 0
        precision: 0
        # Set to 0 = Manual, see registers 43100-43129
        # Set to 1 = Self consumption, aka Anti-feed
        # Set to 2 = Set to AI mode, after set reverts to 1, still determining what register changes in AI mode

      - name: "Marstek m2 Max Charge Power Number"
        unique_id: marstek_m2_max_charge_power_number
        address: 44002
        scan_interval: 10
        slave: 1
        input_type: holding
        data_type: uint16
        unit_of_measurement: W
        scale: 1
        offset: 0
        precision: 0        

      - name: "Marstek m2 Max Discharge Power Number"
        unique_id: marstek_m2_max_discharge_power_number
        address: 44003
        scan_interval: 10
        slave: 1
        input_type: holding
        data_type: uint16
        unit_of_measurement: W
        scale: 1
        offset: 0
        precision: 0

# ---------------
# TEMPLATE SENSOR
# ---------------
template:
  - sensor:
      - name: "Marstek m2 Wifi state"
        unique_id: marstek_m2_wifi_state
        icon: mdi:wifi-alert
        state: >
          {% set mapping = {
            0:'Disconnected',
            1:'Connected' } %}
          {{ mapping[states('sensor.marstek_m2_wifi_state_number') | int] }}

      - name: "Marstek m2 BT state"
        unique_id: marstek_m2_bt_state
        icon: mdi:home-heart
        state: >
          {% set mapping = {
            0:'Disconnected',
            1:'Connected after reboot',
            2:'Connected',
            3:'Active' } %}
          {{ mapping[states('sensor.marstek_m2_bt_state_number') | int] }}

      - name: "Marstek m2 Cloud state"
        unique_id: marstek_m2_cloud_state
        icon: mdi:home-heart
        state: >
          {% set mapping = {
            0:'Disconnected',
            1:'Connected' } %}
          {{ mapping[states('sensor.marstek_m2_cloud_state_number') | int] }}

      - name: "Marstek m2 Inverter State"
        unique_id: marstek_m2_inverter_state
        icon: mdi:state-machine
        state: >
          {% set mapping = {
            0:'Sleep',
            1:'Standby',
            2:'Charge',
            3:'Discharge',
            4:'Fault',
            5:'Idle',
            6:'AC bypass' } %}
          {{ mapping[states('sensor.marstek_m2_inverter_state_number') | int] }}

      - name: "Marstek m2 Battery Cell Voltage Delta"
        unique_id: marstek_m2_battery_cell_voltage_delta
        icon: mdi:sine-wave
        unit_of_measurement: "mV"
        device_class: voltage
        state_class: measurement
        state: >
          {% set sens1= states('sensor.marstek_m2_battery_maximum_cell_voltage') | float(default=0) * 1000 %}
          {% set sens2= states('sensor.marstek_m2_battery_minimum_cell_voltage') | float(default=0) * 1000 %}
          {{ (sens1 - sens2) | round(0) }}

      - name: "Marstek m2 Lifetime Round Trip Efficiency"
        unique_id: marstek_m2_lifetime_round_trip_efficiency
        icon: mdi:chart-bar
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set charging = states('sensor.marstek_m2_lifetime_charging_energy') | float(0) %}
          {% set discharging = states('sensor.marstek_m2_lifetime_discharging_energy') | float(0) %}
          {% if charging > 0 %}
            {{ ((discharging / charging) * 100) | float(0) | round(2) }}
          {% else %}
            0
          {% endif %}

      - name: "Marstek m2 Monthly Round Trip Efficiency"
        unique_id: marstek_m2_monthly_round_trip_efficiency
        icon: mdi:chart-bar
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set charging = states('sensor.marstek_m2_monthly_charging_energy') | float(0) %}
          {% set discharging = states('sensor.marstek_m2_monthly_discharging_energy') | float(0) %}
          {% if charging > 0 %}
            {{ ((discharging / charging) * 100) | float(0) | round(2) }}
          {% else %}
            0
          {% endif %}

      - name: "Marstek m2 Battery Remaining Capacity"
        unique_id: marstek_m2_battery_remaining_capacity
        icon: mdi:battery-arrow-down-outline
        unit_of_measurement: kWh
        state_class: measurement
        device_class: energy_storage
        state: >
          {% set maxbat = 5 | float(default=0) %}
          {% set currentsoc= 11.0 | float(default=0) %}
          {% if has_value('sensor.marstek_m2_battery_total_energy') %}
            {% set maxbat= (states("sensor.marstek_m2_battery_total_energy") | float(default=0) * 1006) | round(0) %}
          {% endif %}
          {% if has_value('sensor.marstek_m2_battery_state_of_charge') %}
            {% set currentsoc= states("sensor.marstek_m2_battery_state_of_charge") | float(default=0) | round(1) %}
          {% endif %}
          {% set currentbat= ((currentsoc / 100 | float(default=0) * (maxbat )) /1000 | float(default=0)) | round(2) %}
          {{ currentbat }}

# ---------------
# TEMPLATE SELECT
# ---------------
  - select:
      - name: Marstek m2 RS485 Control Mode
        unique_id: marstek_m2_rs485_control_mode
        icon: mdi:connection
        options: "{{ ['disable', 'enable'] }}"
        state: >
          {% set opt = (states('sensor.marstek_m2_rs485_control_mode_number') | int(default=0)) %}
          {% set mapper = {
            21947: 'disable',
            21930: 'enable',
          }%}
          {{ mapper.get(opt, 'unknown') }}
        select_option:
          - service: modbus.write_register
            data:
              hub: marstekvenus2
              address: 42000
              slave: 1
              value: >
                {% if option == 'disable' %}21947
                {% elif option == 'enable' %}21930
                {% endif %}
        availability: >
          {{ states('sensor.marstek_m2_rs485_control_mode_number') | is_number }}
        optimistic: true

      - name: Marstek m2 User Work Mode
        unique_id: marstek_m2_user_work_mode
        icon: mdi:auto-mode
        options: "{{ ['manual', 'anti-feed','ai'] }}"
        state: >
          {% set opt = (states('sensor.marstek_m2_user_work_mode_number') | int(default=0)) %}
          {% set mapper = {
            0: 'manual',
            1: 'anti-feed',
            2: 'ai'
          }%}
          {{ mapper.get(opt, 'unknown') }}
        select_option:
          - service: modbus.write_register
            data:
              hub: marstekvenus2
              address: 43000
              slave: 1
              value: >
                {% if option == 'manual' %}0
                {% elif option == 'anti-feed' %}1
                {% elif option == 'ai' %}2
                {% endif %}

      - name: Marstek m2 Forcible Charge/Discharge
        unique_id: marstek_m2_forcible_charge_discharge
        icon: mdi:arrow-up-down
        options: "{{ ['stop', 'charge','discharge'] }}"
        state: >
          {% set opt = (states('sensor.marstek_m2_forcible_charge_discharge_number') | int) %}
          {% set mapper = {
            0: 'stop',
            1: 'charge',
            2: 'discharge'
          }%}
          {{ mapper.get(opt, 'unknown') }}
        select_option:
          - service: modbus.write_register
            data:
              hub: marstekvenus2
              address: 42010
              slave: 1
              value: >
                {% if option == 'stop' %}0
                {% elif option == 'charge' %}1
                {% elif option == 'discharge' %}2
                {% endif %}

      - name: Marstek m2 Backup Function
        unique_id: marstek_m2_backup_function
        icon: mdi:arrow-up-down
        options: "{{ ['enable', 'disable'] }}"
        state: >
          {% set opt = (states('sensor.marstek_m2_backup_function_number') | int(default=0)) %}
          {% set mapper = {
            0: 'enable',
            1: 'disable',
          }%}
          {{ mapper.get(opt, 'unknown') }}
        select_option:
          - service: modbus.write_register
            data:
              hub: marstekvenus2
              address: 41200
              slave: 1
              value: >
                {% if option == 'enable' %}0
                {% elif option == 'disable' %}1
                {% endif %}

# ---------------
# TEMPLATE NUMBER
# ---------------
  - number:
      - name: Marstek m2 Forcible charge Power
        unique_id: marstek_m2_forcible_charge_power
        icon: mdi:tune-variant
        unit_of_measurement: "W"
        state: "{{ states('sensor.marstek_m2_forcible_charge_power_number') | float(0) }}"
        set_value:
          - service: modbus.write_register
            data:
              hub: marstekvenus2
              address: 42020
              slave: 1
              value: "{{ value | int }}"
        step: 1
        min: 0
        max: 2500
        optimistic: true

      - name: Marstek m2 Forcible discharge Power
        unique_id: marstek_m2_forcible_discharge_power
        icon: mdi:tune-variant
        unit_of_measurement: "W"
        state: "{{ states('sensor.marstek_m2_forcible_discharge_power_number') | float(0) }}"
        set_value:
          - service: modbus.write_register
            data:
              hub: marstekvenus2
              address: 42021
              slave: 1
              value: "{{ value | int }}"
        step: 1
        min: 0
        max: 2500
        optimistic: true

      - name: Marstek m2 Charge To SOC
        unique_id: marstek_m2_charge_to_soc
        icon: mdi:tune-variant
        unit_of_measurement: "%"
        state: "{{ states('sensor.charge_to_soc_number') | float(0) }}"
        set_value:
          - service: modbus.write_register
            data:
              hub: marstekvenus2
              address: 42011
              slave: 1
              value: "{{ value | int }}"
        step: 1
        min: 12
        max: 100
        optimistic: true

      - name: Marstek m2 Max. Charge Power
        unique_id: marstek_m2_max_charge_power
        icon: mdi:tune-variant
        unit_of_measurement: "W"
        state: "{{ states('sensor.marstek_m2_max_charge_power_number') | float(0) }}"
        set_value:
          - service: modbus.write_register
            data:
              hub: marstekvenus2
              address: 44002
              slave: 1
              value: "{{ value | int }}"
        step: 1
        min: 0
        max: 2500
        optimistic: true

      - name: Marstek m2 Max. Discharge Power
        unique_id: marstek_m2_max_discharge_power
        icon: mdi:tune-variant
        unit_of_measurement: "W"
        state: "{{ states('sensor.marstek_m2_max_discharge_power_number') | float(0) }}"
        set_value:
          - service: modbus.write_register
            data:
              hub: marstekvenus2
              address: 44003
              slave: 1
              value: "{{ value | int }}"
        step: 1
        min: 0
        max: 2500

        optimistic: true

homeassistant:
  customize: # Add icons to modbus sensors
    sensor.marstek_m2_battery_state_of_charge:
      icon: mdi:power-plug-battery-outline
    sensor.marstek_m2_device_name:
      icon: mdi:rename
    sensor.marstek_m2_ems_version:
      icon: mdi:factory
    sensor.marstek_m2_vns_version:
      icon: mdi:factory
    sensor.marstek_m2_bms_version:
      icon: mdi:factory
    sensor.marstek_m2_com_module_version:
      icon: mdi:factory
    sensor.marstek_m2_mac:
      icon: mdi:rename-box-outline
    sensor.marstek_m2_battery_cell_1_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_2_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_3_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_4_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_5_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_6_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_7_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_8_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_9_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_10_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_11_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_12_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_13_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_14_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_15_voltage:
      icon: mdi:current-dc
    sensor.marstek_m2_battery_cell_16_voltage:
      icon: mdi:current-dc