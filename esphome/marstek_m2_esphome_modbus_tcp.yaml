# -----------------------------------------------------------------
# ESPHome Marstek V3 - Modbus TCP via external component
# Based on Home Assistant registers in marstek_m2_modbus_tcp.yaml
# -----------------------------------------------------------------
# NOTE:
# - Configure Wi-Fi or Ethernet below.
# - ESP32 only (Arduino framework) per external component requirements.
# -----------------------------------------------------------------

esphome:
  name: marstek_m2
  min_version: 2025.11.0

esp32:
  board: esp32dev
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none

logger:
api:
ota:

external_components:
  - source: github://keerekeerweere/esphome_modbus_tcp
    components: [modbustcp, modbustcp_controller]

modbustcp:
  - id: marstek_m2_modbus
    host: !secret marstek_m2_ip
    port: 502
    send_wait_time: 35ms

modbustcp_controller:
  - id: marstek_m2_controller
    modbustcp_id: marstek_m2_modbus
    address: 1
    update_interval: 5s

sensor:
  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Wifi state number"
    id: marstek_m2_wifi_state_number
    address: 30300
    register_type: holding
    value_type: U_WORD
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 BT state number"
    id: marstek_m2_bt_state_number
    address: 30301
    register_type: holding
    value_type: U_WORD
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Cloud state number"
    id: marstek_m2_cloud_state_number
    address: 30302
    register_type: holding
    value_type: U_WORD
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Wifi Signal Strength"
    id: marstek_m2_battery_wifi_signal_strength
    address: 30303
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: dBm
    device_class: signal_strength
    accuracy_decimals: 0
    filters:
      - multiply: -1
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 EMS version"
    id: marstek_m2_ems_version
    address: 30200
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: 59

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 VNS version"
    id: marstek_m2_vns_version
    address: 30202
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: 59

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 BMS version"
    id: marstek_m2_bms_version
    address: 30204
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: 59

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Voltage"
    id: marstek_m2_battery_voltage
    address: 30100
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: V
    device_class: voltage
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    skip_updates: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Current"
    id: marstek_m2_battery_current
    address: 30101
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: A
    device_class: current
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    skip_updates: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Power"
    id: marstek_m2_battery_power
    address: 30001
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: W
    device_class: power
    accuracy_decimals: 0
    skip_updates: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery State Of Charge"  # Venus E v3 only"
    id: marstek_m2_battery_state_of_charge
    address: 34002
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: battery
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Total Energy"
    id: marstek_m2_battery_total_energy
    address: 32105
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: kWh
    accuracy_decimals: 2
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 AC Voltage"
    id: marstek_m2_ac_voltage
    address: 32200
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: V
    device_class: voltage
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 AC Power"
    id: marstek_m2_ac_power
    address: 32202
    register_type: holding
    value_type: S_DWORD
    unit_of_measurement: W
    device_class: power
    accuracy_decimals: 0
    skip_updates: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 AC Power kW"
    id: marstek_m2_ac_power_kw
    address: 32202
    register_type: holding
    value_type: S_DWORD
    unit_of_measurement: kW
    device_class: power
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 AC Frequency"
    id: marstek_m2_ac_frequency
    address: 32204
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: Hz
    device_class: frequency
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Lifetime Charging Energy"
    id: marstek_m2_lifetime_charging_energy
    address: 33000
    register_type: holding
    value_type: U_DWORD
    unit_of_measurement: kWh
    device_class: energy
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Lifetime Discharging Energy"
    id: marstek_m2_lifetime_discharging_energy
    address: 33002
    register_type: holding
    value_type: U_DWORD
    unit_of_measurement: kWh
    device_class: energy
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Daily Charging Energy"
    id: marstek_m2_daily_charging_energy
    address: 33004
    register_type: holding
    value_type: U_DWORD
    unit_of_measurement: kWh
    device_class: energy
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Daily Discharging Energy"
    id: marstek_m2_daily_discharging_energy
    address: 33006
    register_type: holding
    value_type: U_DWORD
    unit_of_measurement: kWh
    device_class: energy
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 monthly Charging Energy"
    id: marstek_m2_monthly_charging_energy
    address: 33008
    register_type: holding
    value_type: U_DWORD
    unit_of_measurement: kWh
    device_class: energy
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Monthly Discharging Energy"
    id: marstek_m2_monthly_discharging_energy
    address: 33010
    register_type: holding
    value_type: U_DWORD
    unit_of_measurement: kWh
    device_class: energy
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 1 Voltage"
    id: marstek_m2_battery_cell_1_voltage
    address: 34018
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 2 Voltage"
    id: marstek_m2_battery_cell_2_voltage
    address: 34019
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 3 Voltage"
    id: marstek_m2_battery_cell_3_voltage
    address: 34020
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 4 Voltage"
    id: marstek_m2_battery_cell_4_voltage
    address: 34021
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 5 Voltage"
    id: marstek_m2_battery_cell_5_voltage
    address: 34022
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 6 Voltage"
    id: marstek_m2_battery_cell_6_voltage
    address: 34023
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 7 Voltage"
    id: marstek_m2_battery_cell_7_voltage
    address: 34024
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 8 Voltage"
    id: marstek_m2_battery_cell_8_voltage
    address: 34025
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 9 Voltage"
    id: marstek_m2_battery_cell_9_voltage
    address: 34026
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 10 Voltage"
    id: marstek_m2_battery_cell_10_voltage
    address: 34027
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 11 Voltage"
    id: marstek_m2_battery_cell_11_voltage
    address: 34028
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 12 Voltage"
    id: marstek_m2_battery_cell_12_voltage
    address: 34029
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 13 Voltage"
    id: marstek_m2_battery_cell_13_voltage
    address: 34030
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 14 Voltage"
    id: marstek_m2_battery_cell_14_voltage
    address: 34031
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 15 Voltage"
    id: marstek_m2_battery_cell_15_voltage
    address: 34032
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Cell 16 Voltage"
    id: marstek_m2_battery_cell_16_voltage
    address: 34033
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Internal Temperature"
    id: marstek_m2_internal_temperature
    address: 35000
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: °C
    device_class: temperature
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Internal MOS1 Temperature"
    id: marstek_m2_internal_mos1_temperature
    address: 35001
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: °C
    device_class: temperature
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 119

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Internal MOS2 Temperature"
    id: marstek_m2_internal_mos2_temperature
    address: 35002
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: °C
    device_class: temperature
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 119

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Max Cell Temperature"
    id: marstek_m2_max_cell_temperature
    address: 35010
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: °C
    device_class: temperature
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Min Cell Temperature"
    id: marstek_m2_min_cell_temperature
    address: 35011
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: °C
    device_class: temperature
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 5

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Inverter State Number"
    id: marstek_m2_inverter_state_number
    address: 35100
    register_type: holding
    value_type: U_WORD

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Charge Voltage Limit"
    id: marstek_m2_battery_charge_voltage_limit
    address: 35110
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 17

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Charge Current Limit"
    id: marstek_m2_battery_charge_current_limit
    address: 35111
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 17

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Discharge Current Limit"
    id: marstek_m2_battery_discharge_current_limit
    address: 35112
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    skip_updates: 17

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Maximum Cell Voltage"
    id: marstek_m2_battery_maximum_cell_voltage
    address: 37007
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 17

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Battery Minimum Cell Voltage"
    id: marstek_m2_battery_minimum_cell_voltage
    address: 37008
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    skip_updates: 17

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Backup Function Number"
    id: marstek_m2_backup_function_number
    address: 41200
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 0

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 RS485 Control Mode Number"
    id: marstek_m2_rs485_control_mode_number
    address: 42000
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 0

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Forcible Charge Discharge Number"
    id: marstek_m2_forcible_charge_discharge_number
    address: 42010
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 0

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Charge To SOC Number"
    id: marstek_m2_charge_to_soc_number
    address: 42011
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    accuracy_decimals: 0

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Forcible Charge Power Number"
    id: marstek_m2_forcible_charge_power_number
    address: 42020
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: W
    accuracy_decimals: 0

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Forcible Discharge Power Number"
    id: marstek_m2_forcible_discharge_power_number
    address: 42021
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: W
    accuracy_decimals: 0

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 User Work Mode number"
    id: marstek_m2_user_work_mode_number
    address: 43000
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Max Charge Power Number"
    id: marstek_m2_max_charge_power_number
    address: 44002
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: W
    accuracy_decimals: 0
    skip_updates: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Max Discharge Power Number"
    id: marstek_m2_max_discharge_power_number
    address: 44003
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: W
    accuracy_decimals: 0
    skip_updates: 1

  - platform: template
    name: "Marstek m2 Battery Cell Voltage Delta"
    id: marstek_m2_battery_cell_voltage_delta
    unit_of_measurement: "mV"
    device_class: voltage
    accuracy_decimals: 0
    update_interval: 30s
    lambda: |-
      const float max_v = id(marstek_m2_battery_maximum_cell_voltage).state;
      const float min_v = id(marstek_m2_battery_minimum_cell_voltage).state;
      if (isnan(max_v) || isnan(min_v)) return NAN;
      return (max_v - min_v) * 1000.0f;

  - platform: template
    name: "Marstek m2 Lifetime Round Trip Efficiency"
    id: marstek_m2_lifetime_round_trip_efficiency
    unit_of_measurement: "%"
    accuracy_decimals: 2
    update_interval: 60s
    lambda: |-
      const float charging = id(marstek_m2_lifetime_charging_energy).state;
      const float discharging = id(marstek_m2_lifetime_discharging_energy).state;
      if (isnan(charging) || isnan(discharging) || charging <= 0.0f) return NAN;
      return (discharging / charging) * 100.0f;

  - platform: template
    name: "Marstek m2 Monthly Round Trip Efficiency"
    id: marstek_m2_monthly_round_trip_efficiency
    unit_of_measurement: "%"
    accuracy_decimals: 2
    update_interval: 60s
    lambda: |-
      const float charging = id(marstek_m2_monthly_charging_energy).state;
      const float discharging = id(marstek_m2_monthly_discharging_energy).state;
      if (isnan(charging) || isnan(discharging)) return NAN;
      if (charging <= 0.0f) return 0.0f;
      return (discharging / charging) * 100.0f;

  - platform: template
    name: "Marstek m2 Battery Remaining Capacity"
    id: marstek_m2_battery_remaining_capacity
    unit_of_measurement: "kWh"
    device_class: energy
    accuracy_decimals: 2
    update_interval: 60s
    lambda: |-
      const float maxbat = id(marstek_m2_battery_total_energy).state;
      const float soc = id(marstek_m2_battery_state_of_charge).state;
      if (isnan(maxbat) || isnan(soc)) return NAN;
      return (soc / 100.0f) * maxbat;

text_sensor:
  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 MAC"
    id: marstek_m2_mac
    address: 30304
    register_type: holding
    register_count: 6
    response_size: 12
    raw_encode: ANSI
    skip_updates: 59

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 COM Module version"
    id: marstek_m2_com_module_version
    address: 30350
    register_type: holding
    register_count: 6
    response_size: 12
    raw_encode: ANSI
    skip_updates: 59

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Device Name"
    id: marstek_m2_device_name
    address: 31000
    register_type: holding
    register_count: 10
    response_size: 20
    raw_encode: ANSI
    skip_updates: 59

  - platform: template
    name: "Marstek m2 Wifi State"
    id: marstek_m2_wifi_state
    update_interval: 30s
    lambda: |-
      if (isnan(id(marstek_m2_wifi_state_number).state)) return std::string("unknown");
      switch ((int) id(marstek_m2_wifi_state_number).state) {
        case 0: return std::string("Disconnected");
        case 1: return std::string("Connected");
        default: return std::string("Unknown");
      }

  - platform: template
    name: "Marstek m2 BT State"
    id: marstek_m2_bt_state
    update_interval: 30s
    lambda: |-
      if (isnan(id(marstek_m2_bt_state_number).state)) return std::string("unknown");
      switch ((int) id(marstek_m2_bt_state_number).state) {
        case 0: return std::string("Disconnected");
        case 1: return std::string("Connected after reboot");
        case 2: return std::string("Connected");
        case 3: return std::string("Active");
        default: return std::string("Unknown");
      }

  - platform: template
    name: "Marstek m2 Cloud State"
    id: marstek_m2_cloud_state
    update_interval: 30s
    lambda: |-
      if (isnan(id(marstek_m2_cloud_state_number).state)) return std::string("unknown");
      switch ((int) id(marstek_m2_cloud_state_number).state) {
        case 0: return std::string("Disconnected");
        case 1: return std::string("Connected");
        default: return std::string("Unknown");
      }

  - platform: template
    name: "Marstek m2 Inverter State"
    id: marstek_m2_inverter_state
    update_interval: 30s
    lambda: |-
      if (isnan(id(marstek_m2_inverter_state_number).state)) return std::string("unknown");
      switch ((int) id(marstek_m2_inverter_state_number).state) {
        case 0: return std::string("Sleep");
        case 1: return std::string("Standby");
        case 2: return std::string("Charge");
        case 3: return std::string("Discharge");
        case 4: return std::string("Fault");
        case 5: return std::string("Idle");
        case 6: return std::string("AC bypass");
        default: return std::string("Unknown state");
      }


select:
  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 RS485 Control Mode"
    id: marstek_m2_rs485_control_mode
    address: 42000
    register_type: holding
    value_type: U_WORD
    optionsmap:
      "disable": 21947
      "enable": 21930

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 User Work Mode"
    id: marstek_m2_user_work_mode
    address: 43000
    register_type: holding
    value_type: U_WORD
    optionsmap:
      "manual": 0
      "anti-feed": 1
      "ai": 2

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Forcible Charge/Discharge"
    id: marstek_m2_forcible_charge_discharge
    address: 42010
    register_type: holding
    value_type: U_WORD
    optionsmap:
      "stop": 0
      "charge": 1
      "discharge": 2

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Backup Function"
    id: marstek_m2_backup_function
    address: 41200
    register_type: holding
    value_type: U_WORD
    optionsmap:
      "enable": 0
      "disable": 1


number:
  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Forcible Charge Power"
    id: marstek_m2_forcible_charge_power
    address: 42020
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Forcible Discharge Power"
    id: marstek_m2_forcible_discharge_power
    address: 42021
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Charge To SOC"
    id: marstek_m2_charge_to_soc
    address: 42011
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    min_value: 12
    max_value: 100
    step: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Max Charge Power"
    id: marstek_m2_max_charge_power
    address: 44002
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1

  - platform: modbustcp_controller
    modbustcp_controller_id: marstek_m2_controller
    name: "Marstek m2 Max Discharge Power"
    id: marstek_m2_max_discharge_power
    address: 44003
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1
